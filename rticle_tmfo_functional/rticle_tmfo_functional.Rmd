---
title: Amazonian forests functional resistance to a selective logging disturbance
author:
  - name: Camille Piponiot
    email: camille.piponiot@gmail.com
    affiliation: 1
    footnote: Corresponding Author
  - name: TmFO authors
  - name: Bruno Hérault
    email: bruno.herault@cirad.fr
    affiliation: 1, 2
address:
  - code: 1
    address: Cirad, UR Forets et Societes, Montferrier-sur-Lez, France
  - code: 2
    address: INPHB, Yamoussoukro, Cote d'Ivoire
abstract: |
  Context.

  Results.

journal: "xxx"
date: "`r Sys.Date()`"
bibliography: library.bib
output: rticles::elsevier_article
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, results='hide',
                      root.dir = "C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO")

library(data.table)
library(ggplot2)
library(gridExtra)
library(kableExtra)
library(tidyr)
library(knitr)
library(ggpubr)
library(raster)
library(sp)
library(rgdal)

### load data 
load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/plotInfo_TmFO.Rdata")
```

```{r, define_params}
agb_loss = 0.4
```

Introduction
==========================

Tropical forests are crucial for most global ecological cycles. They hold 230 Pg of carbon, around 11% of the total carbon in terrestrial ecosystems [@Baccini2012a] and intact tropical forests are estimated to have sequestered an annual 1.19 $\pm$ 0.41 Pg of carbon between 1990-2007 [@Pan2011], about 15% of total anthropogenic carbon emissions, thus playing a major role in climate change mitigation [@IPCC2014]. Tropical forests are also key in the global water cycle, recycling rainfall through vegetation evapotranspiration and thus buffering droughts in adjacent regions [@Staal2018]. Moreover, tropical forests harbour an exceptional biodiversity [@Jenkins2013,@Slik2015], providing species to surrounding regions through biotic interchanges [@Antonelli2018]. The state of tropical forests thus largely determines the functioning of global ecosystems, and hence human well-being. 

The future of tropical forests is however highly uncertain: during the past three centuries, humans activities have triggered rapid changes in global ecosystems, causing massive species extinctions and accelerating climate change through increased carbon emissions [@Crutzen2002]. These changes are particularly intense in the tropics, where forests are being clearcut for agricultural or mining purposes at unprecedented rates, and most remaining forests have or will be heavily impacted by human activities [@Malhi2014]. Disturbances such as droughts, fires, selective logging, or hunting, are increasing in intensity and frequency [@Lewis2015]. Human disturbances modify forest functioning, but the intensity, direction and duration of these changes are still largely unknown. 

One predomininant human activity in tropical forests is the selective logging of a few merchantable trees: around 400 million hectares of tropical forests are designated for timber production [@Blaser2011], and ca. 20% of tropical forests were affected by selective logging between 2000 and 2005 [@Asner2009]. Because selective logging focuses on a few individual trees (typically 5-10 trees per hectare), 65-95% of the forest cover is maintained after logging operations [@Cannon1994,@Pereira2002]. Damage to the forest is concentrated in logging gaps created by tree felling, and in infrastructure (skid trails and, to a lesser extent, roads and log decks) [@Pereira2002,@Asner2004]. 

Disturbances such as selective logging alter the composition and dynamics of tropical forests by provoking a higher-than-normal tree mortality, which can affect some trees more than others. Large trees of commercial value with good mechanical properties are the focus of selective loggers; trees with low-density wood are more vulnerable to droughts [@Mcdowell2018,@Aleixo2019], and trees with thick bark are more resistant to fires [@Brando2012]. Directional mortality has a strait-forward effect on forest composition and structure. 
The indirect effect of disturbance is the higher recruitment of light-demanding species in canopy gaps [@Carreno-Rocabado2012]: these changes in tree species composition can last for several decades [@DeAvila2015]. 

Changes in composition and their effects on forest functioning can be quantified with functional traits [@ChapinIII1997]. Functional traits are measures of an induvidual's features that impact its growth, reproduction and survival, and hence its overall fitness [@Violle2007]. In tropical forests, at least four major functional axes have been described: (i) the leaf economic sectrum (short-lived low-investment leaves vs. tough leaves) [@Wright2004], the wood economic spectrum (fast-growing low-density vs. long-lived high-density wood) [@Chave2009], adult tree stature and height (canopy vs. understory trees) linked to light capture [@Poorter2003] and survival strategy [@Johnson2018], and the seed dispersal strategy (large, zoochorous and resource-rich seeds vs. light anemochorous seeds) [@Poorter2005a]. Together, these four axes explain most of the functional variation observed in forest ecosystems [@Baraloto2012a,@Costa-Saura2019].

Environmental changes can deeply modify a community's composition, with potential effects on its functioning [@Lavorel2002]. Disturbances such as selective logging provoke the canopy openings where canopy trees died, increasing the quantity of light that gets to the soil. This results in the germination and rapid growth of small-seed light-wood species [@Poorter2005a,@Baraloto2012,@Poorter2019]. These light-demanding pioneer species have high growth rates but generally poor resistance to drought [@Aleixo2019]. It has also been shown that selective logging can decrease the canopy height, and consequently total carbon storage [@Rutishauser2016]. Understanding the effects of disturbances on a community's functional composition will thus be key to predict the future of tropical forests in the context of rapid changes in disturbance regimes [@Wright2005].

Ecosystem resilience is a measure of an ecosystem's ability to cope with disturbances [@Holling1973]. It is a key concept to understand the long-term changes in forest composition and dynamics following a disturbance. The notion of resilience can be defined with two essential components: the change in state (or resistance to disturbance), and the time to return to a pre-disturbance state (or recovery) [@Hodgson2015]. 

Resilience, and in particular its change-in-state component, depends strongly on the disturbance frequency and intensity. Additionally, ecological memory of past disturbances is a key component of forest resilience [@Johnstone2016,@Ciemer2019]
In Amazonia, the largest tropical forest biome on Earth (600 million hectares), natural disturbances are mainly driven by drought-related mortality [@Phillips2010] and large windthrows [@Negron-Juarez2018]. Precipitations and windstorms are both spatially structured in Amazonia, with a northwest-southeast precipitation seasonality gradient [@Ciemer2019], and a east-west soil-stability and windstorm-frequency gradient[@Quesada2012,@Espirito-Santo2014]. Understanding how these natural disturbance gradients structure the forest response to a logging disturbance can help improve predictions of Amazonian forests vulnerability to future increases in disturbance regimes [@Davidson2012]. 

Here we assess the resistance of four functional traits (namely wood density, seed mass, specific leaf area and maximum tree diameter) to selective logging in Amazonia. We calibrate an original Bayesian hierarchical model with data from `r sum(plotInfo$idplot.size/plotInfo$plot.size)` permanent forest plots from `r length(unique(plotInfo$site))` long-term experimental sites (`r round(sum(plotInfo$idplot.size))` ha total). Our research questions are: (i) how is the functional composition of Amazonian forests affected by disturbances such as selective logging? (ii) are some functional traits more resistant than others? (iii) does the functional resistance vary across Amazonia, and what factors could explain those variations?



Methods
============

## Study sites

```{r}
## logged plots size range 
plot_size_range = paste(range(subset(plotInfo, treat!="ctrl")[,.(tot_size=sum(idplot.size)), .(site)]$tot_size), collapse = "-")
## % species identification
pSpIdent = round(sum(plotInfo$spIdent)/sum(plotInfo$spIdent+plotInfo$genIdent+plotInfo$noIdent)*100)
pGenIdent = round(sum(plotInfo$genIdent)/sum(plotInfo$spIdent+plotInfo$genIdent+plotInfo$noIdent)*100)
```

Our study includes data from twelve long-term (8–35 year) experimental forest sites located in the Amazon Basin and the Guiana Shield (Figure \ref{fig:smap}) [@Sist2015]. All sites are located in tropical forests with mean annual precipitation $\geq$ 1000 mm. In each site, permanent forest plots (`r plot_size_range` ha per site) were logged, and censused at least once before and twice after logging. 

For each site, we extracted the climatic water deficit (CWD) from Chave et al. [@Chave2014], at a 2.5 arc-minute resolution. Annual stem mortality rates (as a % of live stems) were based on data from unlogged plots inside our sites. For the 5 sites in which no unlogged plot was available, stem mortality rates wer extracted from a map based on the metadata from Johnson and colleagues [@Johnson2016] (extracted from the ForestPlots database [@Lopez-Gonzalez2011]) and interpolated with the R package gstat [@gstat] on a 1$^\circ$ resolution grid. Site coordinates, CWD and stem mortality rates are reported in Table \ref{tab:sites}.

## Data compilation

For sites with plots $\leq$ 1 ha, data from those with the same treatment were aggregated to mitigate the small plot effect on the variation in density of large trees. In each census, all trees $\geq$ 10 cm diameter at breast height (dbh) were marked, measured and identified to the lowest taxonomic level (`r pSpIdent`% to species, `r pGenIdent`% to genus). 

Median values of functional traits were calculated at the species level. Four functional traits were chosen, as proxies of complementary ecosystem functions in tropical forests: (i) the DBH 95th percentile as a proxy of adult tree stature and light demand [@Poorter2003], (ii) the seed mass (log-transformed) as a proxy of the dispersal strategy [@Poorter2005a], (iii) the specific leaf area as a proxy of the assimilation strategy and leaf economic spectrum [@Wright2004] and (iv) the stem wood density as a proxy of growth rate and mechanical support [@Chave2009].

The DBH 95th percentile was chosen because it is more robust than the maximum DBH which is too sensitive to sampling size. The DBH 95th percentile was calculated for all species for which at least 20 individuals were censused in our permanent forest plots. Seed mass and specific leaf area measurements were retrieved from the TRY database [@Kattge2011] (datasets citations xx). Wood density measurements were retrieved from the global wood density database [@Chave2009,@Zanne2009].

Median trait values were calculated per species and genus. Each individual tree in our permanent sample plots was then attributed a value for each trait at the lowest available taxonomic level. Trees with no available species- or genus-specific trait value were given their plot's median trait value. The aboveground biomass of each individual was estimated using the R package BIOMASS [@Rejou-Mechain2017]. 

Selective logging typically targets large trees belonging to a small group of species with commercial value. Those species usually have particular functional trait values, such as large maximum diameters. The functional composition of the largest trees is thus artificially modified because of the selectivity of harvests. Because we are more interested in the indirect effects of selective logging disturbance on the functional composition, i.e. the functional changes induced by tree felling and canopy openings, we excluded large trees with DBH > 35 cm from the analysis. 

For each functional trait $k$ (either $DBH95$, $logSeedMass$, $SLA$, or $WD$), we computed the mean biomass-weighted trait value at census $c$ in plot $p$ in site $s$ as:

\begin{equation}  
MWT_{k,c,p,s} = \frac{\sum_{i \in I_{c,p,s}}(T_{k,i}\cdot agb_i)}{\sum_{i \in I_{c,p,s}}(agb_i)}
\end{equation}

with $T_{k,i}$ the value of trait $k$ for individual tree $i$, $agb_i$ the aboveground biomass of individual tree $i$, and $I_{c,p,s}$ all live trees with DBH $\geq$ 10 cm and $\leq$ 35 cm at census $c$ in plot $p$ in site $s$. Mean trait values were weighted by aboveground biomass to reflect the importance of larger trees in forest functioning (e.g. carbon cycling). 

The distance of a trait value to its initial (pre-logging) value was estimated as: 

\begin{equation}  
dMWT_{k,c,p,s} = \frac{MWT_{k,c,p,s} - MWT0_{k,p,s}}{T0_{k,p,s}}
\end{equation}

## Model calibration

The model presented here aims at capturing the changes in MWT after the disturbance, as well as their recovery. For each trait $k$, the change in MWT at census $c$ in plot $p$ and site $s$  was modelled as:

\begin{equation}  
dMWT_{k,c,p,s} \sim \mathcal{N}\left( \mu_{k,c,p,s}\text{ , } \left(\frac{\sigma_k}{size_p}\right)^2\right)
\end{equation}

where 

\begin{equation}  
\mu_{k,c,p,s} = \Delta_{k,p,s} \cdot \left( \frac{t_c}{tmax_{k,p,s}} \cdot exp\left(1-\frac{t_c}{tmax_{k,p,s}}\right) \right)^{\theta_{k,p,s}}
\end{equation}

with $t_c$ the time since logging (in years) at census $c$; $size_p$ is the size of plot $p$; $\Delta_{k,p,s}$ is the maximum post-disturbance change (negative if the MWT decreases, and positive of it increases). $tmax_{k,p,s}$ is the time taken to reach $\Delta_{k,p,s}$; when $t_c > tmax_{k,p,s}$, the MWT starts to get closer to its initial value, entering the recovery phase which is in some plots not yet observed. $\theta_k$ is a shape parameter that controls the width of the hump; when it increases, the hump is narrower.

Parameters $\Delta_{k,s,p}$ and $tmax_{k,p}$ were modelled with a normal distribution:

\begin{equation}
\Delta_{k,p,s} \sim \mathcal{N} (\mu_{\Delta ks}, \sigma_{\Delta}^2)
\end{equation}

with $\mu_{\Delta ks}$ and $\sigma_{\Delta}$ are respectively the mean and standard deviation of $\Delta$ for trait $k$ in site $s$.

\begin{equation}
tmax_{k,p} \sim \mathcal{N} (\mu m_{ k}, \sigma m^2)
\end{equation}

where $\mu m_{k}$ and $\sigma m$ are respectively the mean and standard deviation of $tmax$ for trait $k$.

```{r method_example, fig.cap="Example of predicted relative MWT change (dMWT) after a disturbance."}
Delta = -2
tmax = 20
theta = 2
curve(Delta * (x/tmax * exp(1-x/tmax) ) ^ theta, xlim = c(0,100), xlab = "Time since logging (yr)", ylab = "dMWT", lwd=2)
arrows(x0=tmax, y0=0,y1=Delta*0.99, code=3, length=0.15)
text(x=tmax, y = Delta/2, pos = 4, labels = expression(Delta), cex=2)
legend("bottomright", legend = expression(Delta*" = -2; tmax = 20 yr; "*theta*" = 2"))
```


$\Delta_{k,p,s}$ is the maximum change of trait $k$ after the disturbance: its absolute value is expected to increase with disturbance intensity. 
We thus modelled it as: 

\begin{equation} 
\Delta_{k,p,s} = loss_p \cdot (\lambda_{0,k} + \sum \lambda_{m,k} Cov_{m,s}) 
\end{equation}

where $loss_p$ is the relative aboveground biomass loss after logging in plot $p$, as a proxy of the disturbance intensity; it is estimated as the difference between the pre-logging aboveground biomass and the minimum biomass in the first 4 years after logging, divided by the pre-logging aboveground biomass (similar to @Piponiot2016). 
$Cov_{m,s}$ is the value of covariate $m$ (either the mortality rate or the climatic water deficit) in site $s$. 

Bayesian hierarchical models were inferred through MCMC methods using an adaptive form of the Hamiltonian Monte Carlo sampling  using the R language [@RDevelopementTeam2018] and the Rstan package [@Carpenter2015]. A detailed list of priors is provided in Table XXX (informative priors?).

## Predictions

Predictions of maximum MWT change after the disturbance were made at the Amazonian level on a 1$^\circ$ grid, i.e. the coarsest resolution of input maps, and errors were propagated with the following steps: 

1. For each cell $j$ of the grid: (i) a value of stem mortality was taken from the map of stem mortality fitted with the data from [@Johnson2016] (see [@Piponiot2019]); (ii) a value of precipitation seasonality was taken from the distribution of pixel values in the Worldclim map [@Chave2014] that were inside the cell. 

2. Parameters $\lambda_{0,k}$ and $\lambda_{m,k}$ were taken from their posterior distribution.

3. For each trait $k$ and grid cell $j$, predictions of maximum MWT change $\Delta_{k,j}$ after a disturbance were calculated using a biomass loss of $loss =$ `r  agb_loss*100`%: 
\begin{equation} 
\Delta_{k,j} = loss \cdot (\lambda_{0,k} + \sum \lambda_{m,k} Cov_{m,j}) 
\end{equation}

These steps were repeated 1000 times and summary statistcs were calculated for each 1$^\circ$ grid cell. 


Results and discussion
============

```{r}
load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/parsCov_seas_smort.Rdata")
range_tmax = paste0("[",paste(round(quantile(pars_cov$tmax, c(0.025,0.975))), collapse=", "),"]")
```

```{r lambdas, fig.height=3, fig.width=6, fig.cap="\\label{fig:lambdas}Violin plots of covariates effect on maximum relative MWT change per trait. *intercept* is the value when all covariates are null; *smort* is the effect of the stem mortality rate; *seas* is the effect of the precipitation seasonality. Dots represent the median value, and the segments are the 95% confidence intervals.  All covariates were scaled and centered."}

load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/parsCov_seas_smort.Rdata")

df = unique(pars_cov[, c("iter","trait", grep("lambda", colnames(pars_cov), value = TRUE)), with = F])
df_lambda = melt(df, id.vars = c("iter","trait"), variable.name = "covariate")
# change parameter's name
df_lambda[,covariate := gsub("lambda_", "", covariate)]
df_lambda[,covariate := gsub("lambda0", "intercept", covariate)]

## 95% confidence interval
lambda_ci = df_lambda[, .(inf = quantile(value, 0.025), 
                          med = quantile(value, 0.5), 
                          sup = quantile(value, 0.975)), .(trait, covariate)]

## order covariates in graph
lambda_ci$covariate = factor(lambda_ci$covariate, levels = c("smort","seas","intercept"))
df_lambda$covariate = factor(df_lambda$covariate, levels = c("smort","seas","intercept"))
# plot
ggplot(lambda_ci, aes(x = covariate)) + 
  geom_hline(yintercept = 0, lty= 2) + 
  geom_violin(data = df_lambda, aes(y = value, fill=covariate), colour=NA, alpha=0.3) +
  geom_pointrange(aes(y = med, ymin = inf, ymax = sup, colour = covariate), lwd = 0.5) + 
  coord_flip() + facet_wrap( ~ trait) +
  labs(y = "Parameter value", x = "Covariate") + theme(legend.position = "none") + 
  theme_bw()
```


```{r maps_pred, fig.cap="Prediction maps of maximum relative CWD change (i.e. resistance to disturbance) by trait. Warm colors (from yellow to red) show a decreases in MWT; blue colors show an increase in MWT. Black dots are study sites location. Pixels with "}
load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/maps_rticle.Rdata")
load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/site_coord.Rdata")

## keep only sites used in this study
load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/plotInfo_TmFO.Rdata")
site_coord = merge(site_coord, unique(plotInfo[,"site"]), by = "site")

#### standardize covariates values
grd_cov$smort = (grd_cov$smort - mean(site_coord$smort))/sd(site_coord$smort)
grd_cov$seas = (grd_cov$seas - mean(site_coord$seas))/sd(site_coord$seas)

all_pix = grd_cov[,c("seas","smort")]
## observations, scaled
obs = scale(site_coord[,c("seas","smort")])

## 1) create convex hull
ch <- chull(obs)
coords <- obs[c(ch, ch[1]),]  # closed polygon

## 2) create buffer around convex hull
p = Polygon(coords)
ps = Polygons(list(p),1)
sps = SpatialPolygons(list(ps))
buff = buffer(sps, width = 1)
## remove points outside the buffer
grd_cov = grd_cov[!is.na(over(SpatialPoints(all_pix),buff)),]


## prediction data table: pixel id * trait * iteration id
grd_cov$idpix = 1:nrow(grd_cov)
df_pred = data.table(expand.grid(idpix = 1:nrow(grd_cov), 
                                 iter = unique(df_lambda$iter),
                                 trait = unique(df_lambda$trait)))
df_pred = merge(df_pred, grd_cov, by = "idpix")  ## + iter
df_pred = merge(unique(pars_cov[,c("iter","trait","lambda0","lambda_seas","lambda_smort")]), 
                df_pred, by = c("iter","trait"))
df_pred[, Delta := agb_loss*(lambda0 + lambda_seas*seas + lambda_smort*smort)]

grd_pred = df_pred[,.(inf = quantile(Delta, 0.025), 
                      med = quantile(Delta, 0.5), 
                      sup = quantile(Delta, 0.975)), 
                   .(trait, long, lat)]

ggplot(grd_pred) + geom_raster(aes(x = long, y = lat, fill = med*100)) + 
  scale_fill_gradientn(colours = c("firebrick","red","orange","yellow","white","lightblue","blue")) +
  facet_wrap( ~ trait) + coord_equal() + geom_point(data = site_coord, aes(x=Long,y=Lat)) + 
  labs(x = "longitude", y = "latitude", fill = "Maximum relative\nMWT change (%)") + 
  theme(panel.grid = element_blank(), panel.border = element_rect(color = "black", fill=NA), 
        strip.background = element_rect(color = "black"))

## error: also integrate the error on input maps
```


# Model structure and limitations

Model structure: 

The time to reach the maximum trait change was $tmax \in$ `r range_tmax` yr (95% confidence interval), with a median value of `r round(median(pars_cov$tmax))` yr. This value is higher than the total experiment duration in several of our sites. The maximum trait change was therefore not always observed in the data, resulting in large uncertainties over the estimated parameters in our models (Figure xx). The hierarchical structure of our model can partially offset this lack of long-term data in some of our sites, but cannot replace real observations. Unfortunately, long-term permanent forest plots are scarce in the tropics, mainly because they are expensive to repeatedly recensus [@Verburg2003]. Investing in long-term experiments (> 20 years) such as the forest plots used in this study will be extremely valuable to validate our results, and more generally to greatly improve the understanding of tropical forest resilience to disturbances. 

Only trees < 35 cm, but trees > 35 cm constitute xx % of the biomass and have a large weight in forest functioning (e.g. carbon cycling refxx). 

Functional trait measures: high intraspecific variation (eg for SLA [@Derroire2018]), but few individual measures, usually in one location, and no control for ontogeny effect and measurement type (eg for SLA: with our without petiole, rachis, etc, not always reported) (refxx). This can lead to some variability in the data that is difficult to control for. We thus believe that overall trends carry some valuable information, but that plot trajectories are not to be interpreted with to much detail.  

# A consistant functional response to logging disturbance

directional changes in functional composition and comparision to what we already know 

DBH95: decrease

Seed Mass: decrease 

SLA: increase

WD: decrease
[@Verburg2003]: incremement of soft-wood species after logging
[@Baraloto2012]

# Functional resistance and vulnerability

what traits are more vulnerable?

-> vulnerability of wood density in highly seasonal forests (+more exposure to climate change and disturbances in SE Amazonia)

# Functional response to logging is spatially structured in Amazonian forests

- Effect of precipitation regime?

- Naturally disturbed forests may be more functionally resistant

-> ecological memory [@Johnstone2016]

-> wood density and stem mortality [@Fauset2019]




Conclusion
============


Acknowledgements
============

This study was partially funded by the GFclim project (FEDER 20142020, Project GY0006894), two Investissement d’Avenir grants of the ANR (CEBA: ANR-10-LABEX-0025, and the REsilience of Managed Amazonian FORests project funded by LabEx Agropolis: ANR-10-LABX-0001), the Sao Paulo Research Foun- dation (FAPESP: 2013/16262-4 and 2013/50718-5), and Embrapa, and carried out in the framework of the Tropical managed Forests Observatory (TmFO), supported by the Sentinel Landscape program of CGIAR (Consultative Group on International Agricultural Research) Forest Tree and Agroforestry Research Program.

The study has also been supported by the TRY initiative on plant traits (http://www.try-db.org).
The TRY initiative and database is hosted, developed and maintained by J. Kattge and G.
Boenisch (Max Planck Institute for Biogeochemistry, Jena, Germany). TRY is currently
supported by Future Earth/bioDISCOVERY and the German Centre for Integrative
Biodiversity Research (iDiv) Halle-Jena-Leipzig.


Supplementary material
============

## TmFO sites: map and covariates values

```{r smap_tmfo_sites, fig.height=6, fig.width=7, fig.cap="\\label{fig:smap}Location of the 12 experimental permanent forest sites used in this study: the size of the points represents the total monitored area, and the color (from yellow to red) represents the total length of the experiment, as the time interval (in years) between the first and the last census."}
load("C:/Users/camille.piponiot/Google Drive/Data TmFO cleaned/new_data/plot_data.Rdata")
plot_data= merge(plot_data, site_coord, by = "site")

## plot sizes
plot_data = subset(plot_data, !(site%in%c("inp","lch")) | plot.size==4) ## use only subplots (1ha*4 per plot) where all trees >10cm have been measured 
plot_data$plot.size[plot_data$site=="prg"] <- 5.25  ## subplots in paragominas: 5.25ha each
plot_data = unique(plot_data[,c("site","plot","plot.size")])
sites_size = plot_data[,.(totsize=sum(plot.size)),.(site)]

## time period
load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/data_FT_TmFO.Rdata")
diff_year = data_FT[,.(dyear = diff(range(year))),.(site)]

sites_size = merge(sites_size, diff_year,by="site")
site_info = merge(site_coord, sites_size,by="site")
site_info$site_name = as.character(site_info$site_name)
site_info$site_name[site_info$site=="bsl"] <- "Jenaro"

library(ggmap); library(ggrepel)
# newmap <- get_map(location=c(-60,-5), zoom=5, maptype="satellite")
# save(newmap,file="calc_Rdata/sat_map.Rdata")
load("C:/Users/camille.piponiot/Google Drive/volume_recovery/calc_Rdata/sat_map.Rdata")
p1 <- ggmap(newmap) + 
  geom_point(data=site_info, aes(x=Long,y=Lat,  colour=dyear, size=totsize))  +
  geom_text_repel(data=site_info, aes(x=Long,y=Lat,label=site_name),colour="white")+
  scale_size_continuous(name = "Total area (ha)") + 
  theme(axis.title.x=element_blank(),axis.title.y=element_blank()) +
  scale_colour_gradientn(colours = rev(heat.colors(10)), name="Experiment \nduration (yr)")
p1
```


```{r, results = "asis"}
site_table = data.table(site_coord[,c("site_name","Long","Lat","cwd","smort")])
site_table[, Long := round(Long,2)]
site_table[, Lat := round(Lat,2)]
site_table[, cwd := round(cwd)]
site_table[, smort := round(smort,2)]
colnames(site_table) <- c("Site", "Longitude","Latitude", "CWD (mm/yr)","Stem mortality (%)")
kable(site_table, "latex", booktabs = T, caption = "\\label{tab:sites}Summary table of sites' location and covariates value.")
```


## Choice of pixels on prediction maps

goal: represent only pixels that have covariates values close enough to our range of calibration (ie TmFO sites conditions).

Scaled covariates -> convex hull around TmFO sites values -> buffer of 1 (scaled: equivalent to 1 standard deviation) -> all points outside this buffer were removed.

```{r pixel_choice, fig.height=6, fig.width=6}
plot(buff, col="grey", axes=TRUE, 
     xlab = "CWD (centered and scaled)", 
     ylab = "Stem mortality (centered and scaled)", 
     xlim = c(-3.2,max(all_pix[,1])), 
     border = NA)
points(all_pix, pch=19)
points(obs, pch=16, col="red")
lines(coords, col="red")
```

## Goodness of predictions

```{r make_predictions}
load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/data_FT_TmFO.Rdata")
data_FT$id = 1:nrow(data_FT)
site_coord$cwd_sc = scale(site_coord$cwd)
site_coord$smort_sc = scale(site_coord$smort)
data_FT = merge(data_FT, site_coord, by = "site")

## tlog: logging year
data_FT = merge(data_FT, data_FT[,.(tlog = min(year)),.(idplot)], by = "idplot")
data_FT$tlog[data_FT$site == "prc"] = 1986
data_FT$tlog[data_FT$site == "tor"] = 2006
data_FT$tlog[data_FT$site == "cum"] = 2004

## initial value
data_FT = merge(data_FT, data_FT[year <= tlog,.(WMT0 = mean(WMT)),.(idplot, trait)], by = c("idplot","trait"))
data_FT[, dWMT := WMT/WMT0 -1 ]

df_pred = data.table(expand.grid(id = 1:nrow(data_FT), iter = 1:1000))
df_pred = merge(df_pred, subset(data_FT, year > tlog), by = "id")
df_pred = merge(df_pred, pars_cov, by = c("iter", "trait","site","idplot"))
df_pred[, pred := Delta * ((year-tlog)/tmax * exp(1-(year - tlog)/tmax))^theta]

df_pred_ci = merge(df_pred[,.(inf = quantile(pred, 0.025), med = quantile(pred, 0.5), sup = quantile(pred, 0.975)), 
                           .(id, site, idplot,year,trait)], data_FT[,c("id","dWMT")], 
                   by = "id")
```

```{r gof, fig.height=7, fig.width=6}
ggplot(df_pred_ci, aes(x = dWMT, y = med, ymin=inf, ymax=sup, colour=site)) + 
  geom_abline(slope=1, intercept=0, lty=2) + geom_pointrange() + 
  facet_wrap( ~ trait, scale="free") + theme_pubr()
```

## Cross validation

```{r}
with_initial_traits = FALSE
cov_names = c("seas","smort")

load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/parsCov_seas_smort_traits.Rdata")
pars_loo = data.table(site = "all",
                      unique(pars_cov[,c("iter", "k","lambda0", "lambda_seas", 
                                         "lambda_smort", "trait")]))

for (sit in unique(data_FT$site)) {
  load(paste0("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/pars_cov_without_", sit, ".Rdata"))
  pars_loo = rbind(pars_loo, data.table(site = sit, pars_cov))
} 

pars_loo = melt(pars_loo, variable.name = "covar", value.name = "lambda",
                measure.vars = grep("lambda", colnames(pars_loo), value = TRUE))
pars_loo$covar = gsub("lambda|_", "", pars_loo$covar)
pars_loo$covar[pars_loo$covar == "0"] = "intercept"

ci_loo = pars_loo[, .(inf = quantile(lambda, 0.025), 
                      med = quantile(lambda, 0.5), 
                      sup = quantile(lambda, 0.975)), 
                  .(covar, site, trait)]
```

Here we tested the effect of removing one site on final parameter posteriors. All sites were removed sequentially and the model was recalibrated with this new subset of the original data. Covariates effects (intercept, *seas*: seasonality of precipitations and *smort*: stem mortality rate) are reported for each site removal (y axis), for each trait. 

```{r, fig.height = 10, fig.width = 8}
ggplot(ci_loo, aes(x = site, y = med, ymin = inf, ymax = sup)) + 
  geom_hline(yintercept = 0, lty = 2) +
  coord_flip() + 
  geom_pointrange() +
  facet_grid( trait ~ covar)
```



References {#references .unnumbered}
==========

