---
title: Amazonian forests functional resistance to a selective logging disturbance
author:
  - name: Camille Piponiot
    email: camille.piponiot@gmail.com
    affiliation: 1
    footnote: Corresponding Author
  - name: TmFO authors
  - name: Bruno Hérault
    email: bruno.herault@cirad.fr
    affiliation: 1, 2
address:
  - code: 1
    address: Cirad, UR Forets et Societes, Montferrier-sur-Lez, France
  - code: 2
    address: INPHB, Yamoussoukro, Cote d'Ivoire
abstract: |
  This is the abstract.

  It consists of two paragraphs.

journal: "xxx"
date: "`r Sys.Date()`"
bibliography: library.bib
output: rticles::elsevier_article
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, results='hide',
                      root.dir = "C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO")

library(data.table)
library(ggplot2)
library(gridExtra)
library(kableExtra)
library(tidyr)
library(knitr)
library(ggpubr)
library(raster)
library(sp)
library(rgdal)
```


Introduction
==========================

Tropical forests are crucial for most global ecological cycles. They hold xx% of the total carbon in terrestrial ecosystems and are estimated to have sequestered an annual 1.19 $\pm$ 0.41 Pg of carbon between 1990-2007 [@Pan2011], about 15% of total anthropogenic carbon emissions, playing a major role in climate change mitigation [@IPCC2014]. Tropical forests are also key in water cycles, recycling rainfall through vegetation evapotranspiration and thus buffering droughts in adjacent regions [@Staal2018]. Moreover, tropical forests harbour an exceptional biodiversity and are estimated to contain around half of terrestrial species [@MEA2005,@IPBES2019]. The future of tropical forests will thus largely determine the functioning of Earth ecosystems and, in turn, human well-being. 

The future of tropical forests is however highly uncertain: since the mid-twentieth century, humans have triggered rapid changes in the global environment [@Crutzen2002]. Tropical forests are being clearcut for agricultural or mining purposes at unprecedented rates, and most remaining forests have or will be heavily impacted by human activities [@Malhi2014]. Disturbances such as droughts, fires, selective logging, or hunting, are increasing in intensity and frequency [@Lewis2015]. Human disturbances modify forest functioning, but the intensity, direction and duration of these changes are still largely unknown. 

One predomininat human activity in tropical forest is the selective logging of a few merchantable trees: xxx Mha are selectively logged every year in the tropics, and XXx% of tropical forests have been logged at least once. Because selective logging focuses on a few individual trees (typically 5-10 trees per ha), XXX% of the forest cover is maintenained after logging operations. Damage to the forest is concentrated in infrastructure (roads and skid trails to get machines in then logs out of the forest), and in logging gaps created by tree felling. 

Disturbances such as selective logging alter the composition and dynamics of tropical forests. A typical disturbance provokes a higher-than-normal tree mortality. This mortality can affect some trees more than others: large trees of commercial value with good mechanical properties and high wood density are the focus of selective loggers (ref xx); droughts affect particularly large trees with low-density wood [@Mcdowell2018,@Aleixo2019]; (other examples: fires?). 

This high mortality strongly decreases the tree density, and, when large canopy trees are killed, it creates gaps in the forest canopy in which more light gets to the soil. These new local conditions can select for species that have different characteristics such as high growth rates and high light requirements. This indirect effect of the disturbance can modify the forest composition and functioning during several decades [@DeAvila2015] (other ref: functioning xx). 

notion of resilience: measure of how well an ecosystem can cope with disturbances and return to its original (pre-disturbance) state. 2 components = change in state (or resistance to a disturbance) + return time [@Hodgson2015]. [introduce our conceptual framework, disturbance intensity]

functional traits = xxx (definition). characterisation of ecosystem functioning $\rightarrow$ importance to understand how they are affected by disturbances. functional strategies and tradeoffs in forests: leaf and wood economic spectrum, stature, and seed dispersal strategy; explain most of the variation [@Baraloto2012a, @Costa-Saura2019]. selective logging disturbance -> canopy openings, light -> colonisation by small-seed light-wood species [@Poorter2005a,@Poorter2019] cf successional theory -> changes in functional composition [@Carreno-Rocabado2012]. 

environmental control: soil, climate, disturbance history -> affects functional composition [@Costa-Saura2019] and response to disturbance. => spatial variation. example: Amazon = largest tropical forest biome on Earth (50% of tropical rainforests, total area: 600 Mha).  -> 2 large scale gradients that control the dynamics of old-growth forests: dryness gradient (NW-SE) [@Davidson2012] that constraints vegetation growth, and a tree mortality gradient (SW-NE) [@Johnson2016] due to lower soil stability [@Quesada2012] and higher frequency of windstorms [@Espirito-Santo2014] in the southwestern part of Amazonia. 

Here we assess the resistance of 4 functional traits (namely wood density, seed mass, specific leaf area and maximum tree diameter) to selective logging in Amazonia. We calibrate an original Bayesian hierarchical model with data from xxx permanent forest plots from 12 long-term experimental sites. Our research questions are: (i) how is the functional composition of Amazonian forests affected by disturbances such as selective logging? (ii) are some functional traits more resistant than others? (iii) does the functional resistance vary across Amazonia, and what factors could explain those variations?



Methods
============

## Study sites

```{r}
## logged plots size range 
load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/plotInfo_TmFO.Rdata")
plot_size_range = paste(range(subset(plotInfo, treat!="ctrl")[,.(tot_size=sum(idplot.size)), .(site)]$tot_size), collapse = "-")
```

Our study includes data from twelve long-term (8–35 year) experimental forest sites located in the Amazon Basin and the Guiana Shield (Figure \ref{fig:smap}) [@Sist2015]. All sites are located in tropical forests with mean annual precipitation $\geq$ 1000 mm. In each site, permanent forest plots (`r plot_size_range` ha per site) were logged, and censused at least once before and at least twice after logging. 

For each site, we extracted the climatic water deficit (CWD) from Chave et al. [@Chave2014], at a 2.5 arc-minute resolution. Annual stem mortality rates (as a % of live stems) were based on data from unlogged plots inside our sites. For the 5 sites in which no unlogged plot was available, stem mortality rates wer extracted from a map based on the metadata from Johnson and colleagues [@Johnson2016] (extracted from the ForestPlots database [@Lopez-Gonzalez2011]) and interpolated with the R package gstat [@gstat] on a 1$^\circ$ resolution grid. Site coordinates, CWD and stem mortality rates are reported in Table \ref{tab:sites}.

## Data compilation

For sites with plots $\leq$ 1 ha, data from those with the same treatment were aggregated to mitigate the small plot effect on the variation in density of large trees. In each census, all trees $\geq$ 10 cm diameter at breast height (dbh) were marked, measured and identified to the lowest taxonomic level (xx% to species, xx% to genus). 

Median values of functional traits were calculated at the species level. Four functional traits were chosen, as proxies of complementary ecosystem functions in tropical forests: (i) the DBH 95th percentile as a proxy of tree stature (refxx), (ii) the seed mass (log-transformed) as a proxy of the dispersal strategy (ref), (iii) the specific leaf area as a proxy of the assimilation strategy and leaf economic spectrum [@Wright2004] and (iv) the stem wood density as a proxy of growth rate and mechanical support [@Chave2009].

The DBH 95th percentile was chosen because it is more robust than the maximum DBH which is too sensitive to sampling size. The DBH 95th percentile was calculated for all species for which at least 20 individuals were censused in our permanent forest plots. Seed mass and specific leaf area measurements were retrieved from the TRY database [@Kattge2011] (check other citations xxx). Wood density measurements were retrieved from the global wood density database [@Chave2009,@Zanne2009].

Median trait values were calculated per species and genus. Each individual tree in our permanent sample plots was then attributed a value for each trait at the lowest available taxonomic level. Trees with no available species- or genus-specific trait value were given their plot's median trait value. The aboveground biomass of each individual was estimated using the R package BIOMASS [@Rejou-Mechain2017]. 

Selective logging typically targets large trees belonging to a small group of species with commercial value. Those species usually have particular functional trait values, such as large maximum diameters and high wood density [xx]. The functional composition of the largest trees is thus artificially modified because of the selectivity of harvests. Because we are more interested in the indirect effects of selective logging disturbance on the functional composition, i.e. the functional changes induced by tree felling and canopy openings, we excluded large trees with DBH > 35 cm from the analysis. 

For each functional trait $k$ (either $DBH95$, $logSeedMass$, $SLA$, or $WD$), we computed the mean biomass-weighted trait value at census $c$ in plot $p$ in site $s$ as:

\begin{equation}  
MWT_{k,c,p,s} = \frac{\sum_{i \in I_{c,p,s}}(T_{k,i}\cdot agb_i)}{\sum_{i \in I_{c,p,s}}(agb_i)}
\end{equation}

with $T_{k,i}$ the value of trait $k$ for individual tree $i$, $agb_i$ the aboveground biomass of individual tree $i$, and $I_{c,p,s}$ all live trees with DBH $\geq$ 10 cm and $\leq$ 35 cm at census $c$ in plot $p$ in site $s$. Mean trait values were weighted by aboveground biomass to reflect the importance of larger trees in forest functioning (refxx). 

The distance of a trait value to its initial (pre-logging) value was estimated as: 

\begin{equation}  
dMWT_{k,c,p,s} = \frac{MWT_{k,c,p,s} - MWT0_{k,p,s}}{T0_{k,p,s}}
\end{equation}

## Model calibration

The model presented here aims at capturing the changes in MWT after the disturbance, as well as their recovery. For each trait $k$, the change in MWT at census $c$ in plot $p$ and site $s$  was modelled as:

\begin{equation}  
dMWT_{k,c,p,s} \sim \mathcal{N}\left( \mu_{k,c,p,s}\text{ , } \left(\frac{\sigma_k}{size_p}\right)^2\right)
\end{equation}

where 

\begin{equation}  
\mu_{k,c,p,s} = \Delta_{k,p,s} \cdot \left( \frac{t_c}{tmax_{k,p,s}} \cdot exp\left(1-\frac{t_c}{tmax_{k,p,s}}\right) \right)^{\theta_{k,p,s}}
\end{equation}

with $t_c$ the time since logging (in years) at census $c$; $size_p$ is the size of plot $p$; $\Delta_{k,p,s}$ is the maximum post-disturbance change (negative if the MWT decreases, and positive of it increases). $tmax_{k,p,s}$ is the time taken to reach $\Delta_{k,p,s}$; when $t_c > tmax_{k,p,s}$, the MWT starts to get closer to its initial value, entering the recovery phase which is in some plots not yet observed. $\theta_k$ is a shape parameter that controls the width of the hump; when it increases, the hump is narrower.

Parameters $\Delta_{k,s,p}$ and $tmax_{k,p}$ were modelled with a normal distribution:

\begin{equation}
\Delta_{k,p,s} \sim \mathcal{N} (\mu_{\Delta ks}, \sigma_{\Delta}^2)
\end{equation}

with $\mu_{\Delta ks}$ and $\sigma_{\Delta}$ are respectively the mean and standard deviation of $\Delta$ for trait $k$ in site $s$.

\begin{equation}
tmax_{k,p} \sim \mathcal{N} (\mu m_{ k}, \sigma m^2)
\end{equation}

where $\mu m_{k}$ and $\sigma m$ are respectively the mean and standard deviation of $tmax$ for trait $k$.

```{r method_example, fig.cap="Example of predicted relative MWT change (dMWT) after a disturbance."}
Delta = -2
tmax = 20
theta = 2
curve(Delta * (x/tmax * exp(1-x/tmax) ) ^ theta, xlim = c(0,100), xlab = "Time since logging (yr)", ylab = "dMWT", lwd=2)
arrows(x0=tmax, y0=0,y1=Delta*0.99, code=3, length=0.15)
text(x=tmax, y = Delta/2, pos = 4, labels = expression(Delta), cex=2)
legend("bottomright", legend = expression(Delta*" = -2; tmax = 20 yr; "*theta*" = 2"))
```


$\Delta_{k,p,s}$ is the maximum change of trait $k$ after the disturbance: its absolute value is expected to increase with disturbance intensity. 
We thus modelled it as: 

\begin{equation} 
\Delta_{k,p,s} = loss_p \cdot (\lambda_{0,k} + \sum \lambda_{m,k} Cov_{m,s}) 
\end{equation}

where $loss_p$ is the relative aboveground biomass loss after logging in plot $p$, as a proxy of the disturbance intensity; it is estimated as the difference between the pre-logging aboveground biomass and the minimum biomass in the first 4 years after logging, divided by the pre-logging aboveground biomass (similar to @Piponiot2016). 
$Cov_{m,s}$ is the value of covariate $m$ (either the mortality rate or the climatic water deficit) in site $s$. 

Bayesian hierarchical models were inferred through MCMC methods using an adaptive form of the Hamiltonian Monte Carlo sampling  using the R language [@RDevelopementTeam2018] and the Rstan package [@Carpenter2015]. A detailed list of priors is provided in Table XXX (informative priors?).

## Predictions

Predictions of maximum MWT change after the disturbance were made at the Amazonian level on a 1$^\circ$ grid, i.e. the coarsest resolution of input maps, and errors were propagated with the following steps: 

1. For each cell $j$ of the grid: (i) a value of stem mortality was taken from xxx (cf piponiot 2019); (ii) a value of CWD was taken from the distribution of pixel values in the Chave et al map [@Chave2014] that were inside the cell. 

2. Parameters $\lambda_{0,k}$ and $\lambda_{m,k}$ were taken from their posterior distribution.

3. For each trait $k$ and grid cell $j$, predictions of maximum MWT change $\Delta_{k,j}$ after a disturbance were calculated using a biomass loss of xxx%: 
\begin{equation} 
\Delta_{k,j} = xx \cdot (\lambda_{0,k} + \sum \lambda_{m,k} Cov_{m,j}) 
\end{equation}

These steps were repeated 1000 times and summary statistcs were calculated for each 1$^\circ$ grid cell. 


Results
============

```{r}
load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/parsCov2.Rdata")
range_tmax = paste0("[",paste(round(quantile(pars_cov$tmax, c(0.025,0.975))), collapse=", "),"]")
```

## Trait change predictions fitness

tmax $\in$ `r range_tmax` yr (95% confidence interval)


## Traits variation and resistance to logging

```{r lambdas, fig.height=3, fig.width=6, fig.cap="\\label{fig:lambdas}Violin plots of covariates effect on maximum relative MWT change per trait. *intercept* is the value when all covariates are null; *smort* is the effect of the stem mortality; *cwd* is the effect of the climatic water deficit. Dots represent the median value, and the segments are the 95% confidence intervals.  All covariates were scaled and centered."}

load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/parsCov2.Rdata")

df = unique(pars_cov[, c("iter","trait", grep("lambda", colnames(pars_cov), value = TRUE)), with = F])
df_lambda = melt(df, id.vars = c("iter","trait"), variable.name = "covariate")
# change parameter's name
df_lambda[,covariate := gsub("lambda_", "", covariate)]
df_lambda[,covariate := gsub("lambda0", "intercept", covariate)]

## 95% confidence interval
lambda_ci = df_lambda[, .(inf = quantile(value, 0.025), 
                          med = quantile(value, 0.5), 
                          sup = quantile(value, 0.975)), .(trait, covariate)]

## order covariates in graph
lambda_ci$covariate = factor(lambda_ci$covariate, levels = c("smort","cwd","intercept"))
df_lambda$covariate = factor(df_lambda$covariate, levels = c("smort","cwd","intercept"))
# plot
ggplot(lambda_ci, aes(x = covariate)) + 
  geom_hline(yintercept = 0, lty= 2) + 
  geom_violin(data = df_lambda, aes(y = value, fill=covariate), colour=NA, alpha=0.3) +
  geom_pointrange(aes(y = med, ymin = inf, ymax = sup, colour = covariate), lwd = 0.5) + 
  coord_flip() + facet_wrap( ~ trait) +
  labs(y = "Parameter value", x = "Covariate") + theme(legend.position = "none") + 
  theme_bw()
```

Figure \ref{fig:lambdas}



## Spatial configuration and predictions

```{r maps_pred, fig.cap="Prediction maps of maximum relative CWD change (i.e. resistance to disturbance) by trait. Warm colors (from yellow to red) show a decreases in MWT; blue colors show an increase in MWT. Black dots are study sites location. Pixels with "}
load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/maps_rticle.Rdata")
load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/site_coord.Rdata")

## keep only sites used in this study
load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/plotInfo_TmFO.Rdata")
site_coord = merge(site_coord, unique(plotInfo[,"site"]), by = "site")

#### standardize covariates values
grd_cov$smort = (grd_cov$smort - mean(site_coord$smort))/sd(site_coord$smort)
grd_cov$cwd = (grd_cov$cwd - mean(site_coord$cwd))/sd(site_coord$cwd)

all_pix = grd_cov[,c("cwd","smort")]
## observations, scaled
obs = scale(site_coord[,c("cwd","smort")])

## 1) create convex hull
ch <- chull(obs)
coords <- obs[c(ch, ch[1]),]  # closed polygon

## 2) create buffer around convex hull
p = Polygon(coords)
ps = Polygons(list(p),1)
sps = SpatialPolygons(list(ps))
buff = buffer(sps, width = 1)
## remove points outside the buffer
grd_cov = grd_cov[!is.na(over(SpatialPoints(all_pix),buff)),]


## prediction data table: pixel id * trait * iteration id
grd_cov$idpix = 1:nrow(grd_cov)
df_pred = data.table(expand.grid(idpix = 1:nrow(grd_cov), 
                                 iter = unique(df_lambda$iter),
                                 trait = unique(df_lambda$trait)))
df_pred = merge(df_pred, grd_cov, by = "idpix")  ## + iter
df_pred = merge(unique(pars_cov[,c("iter","trait","lambda0","lambda_cwd","lambda_smort")]), 
                df_pred, by = c("iter","trait"))
df_pred[, Delta := lambda0 + lambda_cwd*cwd + lambda_smort*smort]

grd_pred = df_pred[,.(inf = quantile(Delta, 0.025), 
                      med = quantile(Delta, 0.5), 
                      sup = quantile(Delta, 0.975)), 
                   .(trait, long, lat)]

ggplot(grd_pred) + geom_raster(aes(x = long, y = lat, fill = med*100)) + 
  scale_fill_gradientn(colours = c("firebrick","red","orange","yellow","white","lightblue","blue")) +
  facet_wrap( ~ trait) + coord_equal() + geom_point(data = site_coord, aes(x=Long,y=Lat)) + 
  labs(x = "longitude", y = "latitude", fill = "Maximum relative\nMWT change (%)") + 
  theme(panel.grid = element_blank(), panel.border = element_rect(color = "black", fill=NA), 
        strip.background = element_rect(color = "black"))

## error: also integrate the error on input maps
```


Discussion
============

- direction of changes: expected or not? 

- which traits are predicted to be more resistant




Supplementary material
============

## TmFO sites: map and covariates values

```{r smap_tmfo_sites, fig.height=6, fig.width=7, fig.cap="\\label{fig:smap}Location of the 15 experimental permanent forest sites used in this study: the size of the points represents the total monitored area, and the color (from yellow to red) represents the total length of the experiment, as the time interval (in years) between the first and the last census."}
load("C:/Users/camille.piponiot/Google Drive/Data TmFO cleaned/new_data/plot_data.Rdata")
plot_data= merge(plot_data, site_coord, by = "site")

## plot sizes
plot_data = subset(plot_data, !(site%in%c("inp","lch")) | plot.size==4) ## use only subplots (1ha*4 per plot) where all trees >10cm have been measured 
plot_data$plot.size[plot_data$site=="prg"] <- 5.25  ## subplots in paragominas: 5.25ha each
plot_data = unique(plot_data[,c("site","plot","plot.size")])
sites_size = plot_data[,.(totsize=sum(plot.size)),.(site)]

## time period
load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/data_FT_TmFO.Rdata")
diff_year = data_FT[,.(dyear = diff(range(year))),.(site)]

sites_size = merge(sites_size, diff_year,by="site")
site_info = merge(site_coord, sites_size,by="site")

library(ggmap); library(ggrepel)
# newmap <- get_map(location=c(-60,-5), zoom=5, maptype="satellite")
# save(newmap,file="calc_Rdata/sat_map.Rdata")
load("C:/Users/camille.piponiot/Google Drive/volume_recovery/calc_Rdata/sat_map.Rdata")
p1 <- ggmap(newmap) + 
  geom_point(data=site_info, aes(x=Long,y=Lat,  colour=dyear, size=totsize))  +
  geom_text_repel(data=site_info, aes(x=Long,y=Lat,label=site_name),colour="white")+
  scale_size_continuous(name = "Total area (ha)") + labs(title="(a) TmFO sites") +
  theme(axis.title.x=element_blank(),axis.title.y=element_blank()) +
  scale_colour_gradientn(colours = rev(heat.colors(10)), name="Experiment \nduration (yr)")
p1
```


```{r, results = "asis"}
site_table = data.table(site_coord[,c("site_name","Long","Lat","cwd","smort")])
site_table[, Long := round(Long,2)]
site_table[, Lat := round(Lat,2)]
site_table[, cwd := round(cwd)]
site_table[, smort := round(smort,2)]
colnames(site_table) <- c("Site", "Longitude","Latitude", "CWD (mm/yr)","Stem mortality (%)")
kable(site_table, "latex", booktabs = T, caption = "\\label{tab:sites}Summary table of sites' location and covariates value.")
```


## Choice of pixels on prediction maps

goal: represent only pixels that have covariates values close enough to our range of calibration (ie TmFO sites conditions).

Scaled covariates -> convex hull around TmFO sites values -> buffer of 1 (scaled: equivalent to 1 standard deviation) -> all points outside this buffer were removed.

```{r pixel_choice, fig.height=6, fig.width=6}
plot(buff, col="grey", axes=TRUE, 
     xlab = "CWD (centered and scaled)", 
     ylab = "Stem mortality (centered and scaled)", 
     xlim = c(-3.2,max(all_pix[,1])), 
     border = NA)
points(all_pix, pch=19)
points(obs, pch=16, col="red")
lines(coords, col="red")
```

## Goodness of predictions

```{r make_predictions}
load("C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO/data/data_FT_TmFO.Rdata")
data_FT$id = 1:nrow(data_FT)
site_coord$cwd_sc = scale(site_coord$cwd)
site_coord$smort_sc = scale(site_coord$smort)
data_FT = merge(data_FT, site_coord, by = "site")

## tlog: logging year
data_FT = merge(data_FT, data_FT[,.(tlog = min(year)),.(idplot)], by = "idplot")
data_FT$tlog[data_FT$site == "prc"] = 1986
data_FT$tlog[data_FT$site == "tor"] = 2006
data_FT$tlog[data_FT$site == "cum"] = 2004

## initial value
data_FT = merge(data_FT, data_FT[year <= tlog,.(WMT0 = mean(WMT)),.(idplot, trait)], by = c("idplot","trait"))
data_FT[, dWMT := WMT/WMT0 -1 ]

df_pred = data.table(expand.grid(id = 1:nrow(data_FT), iter = 1:1000))
df_pred = merge(df_pred, subset(data_FT, year > tlog), by = "id")
df_pred = merge(df_pred, pars_cov, by = c("iter", "trait","site","idplot"))
df_pred[, pred := Delta * ((year-tlog)/tmax * exp(1-(year - tlog)/tmax))^theta]

df_pred_ci = merge(df_pred[,.(inf = quantile(pred, 0.025), med = quantile(pred, 0.5), sup = quantile(pred, 0.975)), 
                           .(id, site, idplot,year,trait)], data_FT[,c("id","dWMT")], 
                   by = "id")
```

```{r gof, fig.height=7, fig.width=6}
ggplot(df_pred_ci, aes(x = dWMT, y = med, ymin=inf, ymax=sup, colour=site)) + 
  geom_abline(slope=1, intercept=0, lty=2) + geom_pointrange() + 
  facet_wrap( ~ trait, scale="free") + theme_pubr()
```



References {#references .unnumbered}
==========

