---
title: "What drives the functional response to logging in Amazonia?"
output: 
  html_document:
    theme: yeti
    keep_md: true
    toc: true
    toc_float: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, results='hide',
                      root.dir = "C:/Users/camille.piponiot/gitR/functional_trajectories_TmFO")
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

library(data.table)
library(ggplot2)
library(gridExtra)
library(tidyr)
library(knitr)
library(ggpubr)

inference_stan = FALSE
```


In this study we model the functional resistance and resilience of trees recruitement to disturbance (here selective logging), and their spatial variation in Amazonia. 

# Data visualisation

```{r, traits_traj, fig.height=10, fig.width=10}
# to get the data: source("C:/Users/camille.piponiot/Google Drive/biodiversity/codes/get_metadata.R")
load("data/genusData_TmFO.Rdata")
load("data/plotInfo_TmFO.Rdata")
name_traits = c("woodDensity","logSeedMass","SLA","DBH95")

plotInfo = merge(plotInfo, genusData[,.(tlog = min(year)), .(idplot)], by = "idplot")
plotInfo$tlog[plotInfo$site == "prc"] = 1986
plotInfo$tlog[plotInfo$site == "tor"] = 2006
plotInfo$tlog[plotInfo$site == "cum"] = 2004

### reorganize data -> gather dataframes
genusData_melt = melt(genusData, variable.name = "trait", value.name = "value", 
                      measure.vars = grep("D|Seed|SLA",colnames(genusData)), 
                      variable.factor = FALSE)
dfTraits = genusData_melt[,.(WMT = weighted.mean(value, agb), agb_tot = sum(agb)),.(idplot, year, trait, cohort)]

## add plot info (plot size, treatment)
dfTraits = merge(dfTraits, plotInfo, by = c("idplot"))
dfTraits[, agb := agb_tot/idplot.size]

## initial value
md_0 = dfTraits[year <= tlog,.(WMT0 = mean(WMT)),.(site, idplot, trait, treat)]

```

## Traits trajectory {.tabset .tabset-fade .tabset-pills}

Traits chosen: 

- $DBH95$: DBH 95th percentile (per species) as a proxy of the stature

- $logSeedMass$: median seed mass (log-transformed) as a proxy of the dispersal strategy

- $SLA$: median specific leaf area, as a proxy of the assimilation strategy and leaf economic spectrum

- $WD$: median wood density, as a proxy of growth rate and mechanical support

Cohorts: 

- Survivors, ie trees that survived logging

- Recruits, ie trees that passed the 10 cm DBH threshold after logging

Here are represented for each cohort the mean trait value, weighted by the estimated above ground biomass (AGB) of each individual.

```{r}
dfTraits$cohort <- factor(dfTraits$cohort)
levels(dfTraits$cohort) <- c("Recruits", "Survivors")

graph_traits <- function(sit) {
  ggplot(subset(dfTraits, site == sit & cohort == "Recruits"), aes(x = year - tlog, y = WMT, group = idplot, colour = treat)) + 
    geom_line() + geom_point() + 
    geom_point(data = subset(md_0, site == sit), aes(x = 0, y = WMT0), pch = 1, cex = 5) + 
    ylab("MWT") + xlab("Time since logging (yr)") +
    facet_wrap(~trait, scales = "free")
}

tmfo_sites <- as.character(unique(dfTraits$site))
```

### Jenaro 
```{r, fig.height=8, fig.width = 10}
graph_traits("bsl")
```

### Chico Bocao 
```{r, fig.height=10, fig.width = 10}
graph_traits("chb")
```

### Cumaru 
```{r, fig.height=10, fig.width = 10}
graph_traits("cum")
```

### INPA 
```{r, fig.height=10, fig.width = 10}
graph_traits("inp")
```

### Iracema 
```{r, fig.height=10, fig.width = 10}
graph_traits("ira")
```

### La Chonta 
```{r, fig.height=10, fig.width = 10}
graph_traits("lch")
```

### Peteco 
```{r, fig.height=10, fig.width = 10}
graph_traits("pet")
```

### Paracou 
```{r, fig.height=10, fig.width = 10}
graph_traits("prc")
```

### Paragominas 
```{r, fig.height=10, fig.width = 10}
graph_traits("prg")
```

### Tabocal 
```{r, fig.height=10, fig.width = 10}
graph_traits("tbc")
```

### Tapajos 
```{r, fig.height=10, fig.width = 10}
graph_traits("tpj")
```

### Tortue 
```{r, fig.height=10, fig.width = 10}
graph_traits("tor")
```


## Recruits most common genuses and their impact on mean weighted traits {.tabset .tabset-pills}

```{r, fig.height=20, fig.width=12}

recrData = merge(genusData, genusData[cohort=="recr",.(agbR = sum(agb)),
                                      .(idplot, year, cohort)])

recrData = merge(recrData, plotInfo, by=c("site", "idplot"))
```

```{r}
graph_genus <- function(sit) {
  
  dat = subset(recrData, site == sit)
  ## genuses that at least once represent 10% of the total biomass of recruits
  genus_common = unique(as.character(subset(dat, agb/agbR > 0.1 & !(genus %in% c("Oenocarpus", "Indet", NA)))$genus))
  dat$genus2 = as.character(dat$genus)
  dat$genus2[!(dat$genus %in% genus_common)] <- "other"
  dat$genus2 = factor(dat$genus2, levels = c(as.character(genus_common), "other") )
  
  dat_agb = dat[, .(agb = sum(agb)), .(genus2,idplot,year,agbR)]
  dat = merge(dat_agb, dat[, .(woodDensity = weighted.mean(woodDensity, agb),
                                    logSeedMass = weighted.mean(logSeedMass, agb),
                                    SLA = weighted.mean(SLA, agb)), .(genus2)])
  
  g1 = ggplot(dat, aes(x=year, y=agb, fill=genus2)) + 
    geom_area(colour = 1) + facet_wrap( ~ idplot, scales = "free")
  g1
  ## mean traits (weighted by biomass) of recruited genuses in control plots -> reference (= white color in plots)
  # ref = dat[treat=="ctrl", .(woodDensity = weighted.mean(woodDensity, agb),
  #                            logSeedMass = weighted.mean(logSeedMass, agb),
  #                            SLA = weighted.mean(SLA, agb))]
}

```

genus2: genuses with > 10% of the recruits biomass

### Jenaro 
```{r, fig.height=4, fig.width = 10}
graph_genus("bsl")
```

### Chico Bocao 
```{r, fig.height=4, fig.width = 6}
graph_genus("chb")
```

### Cumaru 
```{r, fig.height=10, fig.width = 10}
graph_genus("cum")
```

### INPA 
```{r, fig.height=10, fig.width = 10}
graph_genus("inp")
```

### Iracema 
```{r, fig.height=10, fig.width = 10}
graph_genus("ira")
```

### La Chonta 
```{r, fig.height=10, fig.width = 10}
graph_genus("lch")
```

### Peteco 
```{r, fig.height=10, fig.width = 10}
graph_genus("pet")
```

### Paracou 
```{r, fig.height=10, fig.width = 10}
graph_genus("prc")
```

### Paragominas 
```{r, fig.height=10, fig.width = 10}
graph_genus("prg")
```

### Tabocal 
```{r, fig.height=10, fig.width = 10}
graph_genus("tbc")
```

### Tapajos 
```{r, fig.height=10, fig.width = 10}
graph_genus("tpj")
```

### Tortue 
```{r, fig.height=10, fig.width = 10}
graph_genus("tor")
```

