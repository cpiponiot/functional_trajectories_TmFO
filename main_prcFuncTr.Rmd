---
title: "What drives the functional response to disturbance in Paracou?"
output: 
  html_document:
    theme: yeti
    keep_md: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, results='hide',
                      root.dir = "C:/Users/camille.piponiot/gitR/functional_trajectories_paracou")
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

library(data.table)
library(ggplot2)
library(gridExtra)
library(tidyr)

inference_stan = FALSE
```

# Data visualisation

```{r, traits_traj, fig.height=10, fig.width=10}
# to get the data: source("C:/Users/camille.piponiot/Google Drive/biodiversity/codes/get_metadata_paracou.R")

load("data/genusData.Rdata")
load("data/plotInfo.Rdata")
name_traits = c("woodDensity","logSeedMass","SLA","DBH95")


### reorganize data -> gather dataframes
genusData_melt = melt(genusData, variable.name = "trait", value.name = "value", 
                      measure.vars = grep("D|Seed|SLA",colnames(genusData)), 
                      variable.factor = FALSE)
dfTraits = genusData_melt[,.(WMT = weighted.mean(value, agb)),.(idplot, year, trait, cohort)]

## add plot info (plot size, treatment)
dfTraits = merge(dfTraits, plotInfo)
dfTraits = merge(dfTraits, data.table(treat = c("ctrl","CL","silv","silv+"), treatment = paste("T",0:3,sep="")), by="treat")

## initial value
md_0 = dfTraits[year < 1987,.(WMT0 = mean(WMT)),.(idplot, trait, treatment)]

```

## Traits trajectory 

Traits chosen: 

- $DBH95$: DBH 95th percentile (per species) as a proxy of the stature

- $logSeedMass$: median seed mass (log-transformed) as a proxy of the dispersal strategy

- $SLA$: median specific leaf area, as a proxy of the assimilation strategy and leaf economic spectrum

- $WD$: median wood density, as a proxy of growth rate and mechanical support

Cohorts: 

- Survivors, ie trees that survived logging

- Recruits, ie trees that passed the 10 cm DBH threshold after logging

Here are represented for each cohort the mean trait value, weighted by the estimated above ground biomass (AGB) of each individual.

```{r recr_traj,fig.height=10, fig.width=10}

dfTraits$cohort <- factor(dfTraits$cohort)
levels(dfTraits$cohort) <- c("Recruits", "Survivors")

ggplot(dfTraits, aes(x = year - 1986, y = WMT, group = idplot, colour = treatment)) + 
  geom_line() + geom_point() + 
  geom_point(data = md_0, aes(x = 0, y = WMT0), pch = 1, cex = 5) + 
  ylab("MWT") + xlab("Time since logging (yr)") +
  facet_grid(trait~cohort, scales = "free")

```

For $D$: there seems to be no effect of logging gaps on recruitment, the only effect is on survivors (direct removal of big trees + higher growth rates of big survivors): worth including in the study? 

We can exclude $D$ from the study later. 

## Recruits most common genuses and their impact on mean weighted traits {.tabset .tabset-pills}

### AGB per genus

```{r, fig.height=10, fig.width=12}

recrData = merge(genusData, genusData[cohort=="recr",.(agbR = sum(agb)),.(idplot, year, cohort)])

## genuses that at least once represent 10% of the total biomass of recruits
genus_common = unique(as.character(subset(recrData, agb/agbR > 0.15 & !(genus %in% c("Oenocarpus", "Indet")))$genus)) 

recrData$genus2 = as.character(recrData$genus)
recrData$genus2[!(recrData$genus %in% genus_common)] <- "other"

recrData_agb = recrData[, .(agb = sum(agb)), .(genus2,idplot,year,agbR)]
recrData = merge(recrData_agb, recrData[, .(woodDensity = weighted.mean(woodDensity, agb),
                                        logSeedMass = weighted.mean(logSeedMass, agb),
                                        SLA = weighted.mean(SLA, agb)), .(genus2)])

recrData = merge(recrData, plotInfo, by="idplot")
recrData = merge(recrData, data.table(treat = c("ctrl","CL","silv","silv+"), treatment = paste("T",0:3,sep="")), by="treat")
recrData$bloc = rep(1:3,each=4)[as.numeric(recrData$idplot)]

recrData$genus2 = factor(recrData$genus2, levels = c(as.character(genus_common), "other") )
ggplot(recrData, aes(x=year, y=agb, fill=genus2)) + geom_area(colour = 1) + facet_grid(treatment ~ bloc)

## mean traits (weighted by biomass) of recruited genuses in control plots -> reference (= white color in plots)
ref = recrData[treat=="ctrl", .(woodDensity = weighted.mean(woodDensity, agb),
                                logSeedMass = weighted.mean(logSeedMass, agb),
                                SLA = weighted.mean(SLA, agb))]
```

### Proportion of total AGB 

```{r, fig.height=10, fig.width=12}
ggplot(recrData, aes(x = year, y = agb/agbR, fill = genus2)) + geom_area(colour = 1) + facet_grid(treatment ~ bloc, scales= "free")
```

### Seed mass (log-transformed)

```{r, fig.height=10, fig.width=12}
ggplot(recrData, aes(x = year, y = agb/agbR, group = genus2, fill = logSeedMass)) + geom_area(colour = 1) + facet_grid(treatment ~ bloc, scales= "free") + scale_fill_gradient2(low = "firebrick4", mid = "white", high = "#104E8B", midpoint = ref$logSeedMass)
```

### SLA

```{r, fig.height=10, fig.width=12}
ggplot(recrData, aes(x = year, y = agb/agbR, group = genus2, fill = SLA)) + geom_area(colour = 1) + facet_grid(treatment ~ bloc, scales= "free") + scale_fill_gradient2(low = "firebrick4", mid = "white", high = "#104E8B", midpoint = ref$SLA)
```

### Wood Density

```{r, fig.height=10, fig.width=12}
ggplot(recrData, aes(x = year, y = agb/agbR, group = genus2, fill = woodDensity)) + geom_area(colour = 1) + facet_grid(treatment ~ bloc, scales= "free") + scale_fill_gradient2(low = "firebrick4", mid = "white", high = "#104E8B", midpoint = ref$woodDensity)
```

### Conclusions 

Early pioneer = cecropias (SLA 0 // seed mass -- // WD -- )

Late pioneer = ingas + miconias + tapiriras + vismias (SLA ++ // seed mass - // WD - )

- seed mass follows exactly cecropias dynamics: peaks quickly (low $tmax$, around 10 years) and recovers fast (high $\theta$)

- WD peaks quickly (low $tmax$) but stays low for long (low $\theta$)

- SLA peaks after a long time (high $tmax$) but stays low for longer (low $\theta$)

## What can explain survivors' changes in WMT? (especially with SLA)

### Logging direct effect

Here we investigate the WMT of trees killed during logging operations and compare it to the community WMT. 

The categories are: 

- "logged": trees intentionally logged 

- "devitalized": big trees intentionally poisoned and girdled 

- "damage": non-intentional damage caused by logging operations (skid trails opening, tree felling) / should be random but affects smaller trees more, which have a slightly different functional composition

```{r mortSurvTraits, fig.height = 3, fig.width = 10}
load("data/mortLogging.Rdata")

ggplot(mortLogging, aes(y = (WMT - WMT0)/WMT0*100, x = eventMort, colour=treatment)) + 
  geom_hline(yintercept = 0, lty = 2) + 
  geom_boxplot() + 
  ylab("Difference between killed trees'\nand prelogging trait values (%)") +
  xlab("Type of tree mortality") + 
  facet_wrap( ~ trait, scales = "free")
```

Devitalized trees have a SLA lower than the community's, especially in T2 (that shows the highest change in terms of survivors' SLA), which could partly explain why the SLA of survivors increases sharply in treatments 2 and 3.

### Post-logging survivors dynamics

Here we analyse the WMT of the additional biomass from survivors' growth and the WMT of survivors' mortality, to see if some patterns in survivors dynamics can explain the changes in survivors' traits. 

```{r survDynTraits, fig.height = 10, fig.width = 12}
load("data/dynData.Rdata")

dynData = melt(dynData, measure.vars = grep("WMT", colnames(dynData)))

dynData2 = dynData[, .(value = mean(value)), .(year, treatment, cohort, trait, variable)]
  
  
ggplot(subset(dynData2, cohort == "surv"), aes(x = year, y = value, colour=treatment)) +
  geom_vline(xintercept = 1986, lty = 2) + 
  geom_line() + geom_point() + 
  facet_grid(trait ~ variable, scales = "free") 

```